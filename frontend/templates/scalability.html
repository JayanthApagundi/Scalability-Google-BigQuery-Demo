<!DOCTYPE html>
<html lang="en">
<head>
    <title>Scalability Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Styling for cleaner layout */
        #chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            width: 90%;
            max-width: 1200px;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="text-center py-4">
            <h1>Scalability Metrics</h1>
        </header>

        <!-- Chart Section -->
        <section>
            <h2 class="text-center">Execution Time and Slot Time</h2>
            <div id="chart-container" class="mt-4">
                <canvas id="metricsChart" class="mb-4"></canvas>
            </div>
        </section>

        <!-- Query Metrics Section -->
        <section>
            <h2 class="text-center mt-5">Query Metrics</h2>
            <div id="metricsResults" class="mt-4">
                <p>Loading scalability metrics...</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center mt-5">
            <p>Developed with ❤️ for Distributed Systems Design.</p>
        </footer>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const metricsResultsContainer = document.getElementById("metricsResults");
            const ctx = document.getElementById("metricsChart").getContext('2d');

            try {
                const response = await fetch("http://127.0.0.1:8000/scalability/");
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();

                // Initialize variables for graph data
                const labels = [];
                const executionTimes = [];
                const slotTimes = [];

                // Initialize HTML content for Query Metrics
                let htmlContent = "";

                for (const [queryName, metrics] of Object.entries(data)) {
                    if (metrics.error) {
                        htmlContent += `<div class='alert alert-danger'>
                            ${queryName}: Error - ${metrics.error}</div>`;
                    } else {
                        // Graph data
                        const truncatedName = queryName.length > 20 ? queryName.substring(0, 17) + "..." : queryName;
                        labels.push(truncatedName);
                        executionTimes.push(metrics.execution_time_ms);
                        slotTimes.push(metrics.slot_time_sec);

                        // Query-Level Metrics
                        htmlContent += `
                            <div class='card mb-4'>
                                <div class='card-header bg-info text-white'>
                                    <h5 class="mb-0"><strong>${queryName}</strong></h5>
                                </div>
                                <div class='card-body'>
                                    <p><strong>Execution Time:</strong> ${metrics.execution_time_ms} ms</p>
                                    <p><strong>Slot Time:</strong> ${metrics.slot_time_sec} sec</p>
                                    <p><strong>Total Bytes Processed:</strong> ${metrics.total_bytes_processed} B</p>
                                    <h6 class="mt-3">Execution Stages</h6>
                                    <div class='row'>`;

                        // Stage-Level Details - Side-by-Side Layout
                        metrics.stages.forEach((stage, index) => {
                            htmlContent += `
                                <div class='col-md-4 mb-3'>
                                    <div class='border p-3 shadow-sm rounded'>
                                        <h6><strong>Stage ${index + 1}: ${stage.stage_name}</strong></h6>
                                        <p>Records Read: ${stage.records_read}</p>
                                        <p>Records Written: ${stage.records_written}</p>
                                        <p>Wait Time: ${stage.wait_time} ms</p>
                                        <p>Read Time: ${stage.read_time} ms</p>
                                        <p>Compute Time: ${stage.compute_time} ms</p>
                                        <p>Write Time: ${stage.write_time} ms</p>
                                    </div>
                                </div>`;
                        });

                        htmlContent += `
                                    </div>
                                </div>
                            </div>`;
                    }
                }

                // Render Query Metrics to HTML
                metricsResultsContainer.innerHTML = htmlContent;

                // Generate Chart for Execution Time and Slot Time
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Execution Time (ms)',
                                data: executionTimes,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            },
                            {
                                label: 'Slot Time (sec)',
                                data: slotTimes,
                                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Execution Time and Slot Time Comparison'
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching scalability metrics:", error);
                metricsResultsContainer.innerHTML = "<p class='text-danger'>Error fetching results.</p>";
            }
        });
    </script>
</body>
</html>
